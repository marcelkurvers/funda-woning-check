<!DOCTYPE html>
<html lang="nl">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Woning Rapport - Premium</title>
  <link rel="stylesheet" href="/static/styles.css">

  <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
  <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
  <!--===START SCREEN===-->
  <div id="start-screen" class="hero-container animate-fade">
    <div class="hero-content"><a href="/preferences"
        style="position: absolute; top: 1.5rem; right: 1.5rem; color: #64748b; font-size: 1.5rem; transition: color 0.2s;"
        title="Voorkeuren"><ion-icon name="settings-outline"></ion-icon></a>
      <div style="margin-bottom: 1.5rem;"><span
          style="background: rgba(59, 130, 246, 0.1); color: #3b82f6; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">NIEUW:
          AI ANALYSE 2.0</span></div>
      <h1 class="hero-title">Vastgoed Inzicht.<br><span style="color: #475569;">Binnen 10 seconden.</span></h1>
      <p style="margin-bottom: 2.5rem; color: #64748b; font-size: 1.1rem; line-height: 1.6;">Upload een Funda URL en
        ontvang direct een compleet waarderapport,
        inclusief <strong style="color: #0f172a;">onderhandelingsstrategie</strong>en <strong
          style="color: #0f172a;">verbouwpotentieel</strong>. </p>
      <div class="input-group"><input type="text" id="fc-url" class="hero-input"
          placeholder="https://www.funda.nl/koop/..." /><button id="btn-start" class="hero-btn">Start Analyse</button>
      </div>
      <div style="margin-top: 1rem;"><a href="#" id="toggle-paste" onclick="togglePasteArea(event)"
          style="font-size: 0.9rem; color: #64748b; text-decoration: none; border-bottom: 1px dashed #94a3b8;">Of
          gebruik broncode (handmatig)</a></div>
      <!-- Paste Fallback -->
      <div id="paste-area" class="hidden glass-panel"
        style="margin-top: 2rem; padding: 1.5rem; border-radius: 12px; text-align: left;">
        <p
          style="font-size: 0.9rem; color: #ef4444; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
          <ion-icon name="warning-outline"></ion-icon>Automatische toegang geblokkeerd? Plak hier de broncode
          (Ctrl+U):
        </p><textarea id="fc-paste" rows="6" class="hero-input"
          style="font-size: 0.8rem; font-family: monospace; background: white;"
          placeholder="<html>...</html>"></textarea><button id="btn-paste-submit" class="hero-btn"
          style="margin-top: 1rem; background: #334155;">Verwerk Broncode</button>
      </div>
    </div>
    <!-- Trust badge or features -->
    <div style="margin-top: 3rem; display: flex; gap: 2rem; color: #64748b; font-size: 0.9rem;">
      <div class="flex items-center gap-2"><ion-icon name="checkmark-circle"
          style="color:#10b981;"></ion-icon>Marktwaarde Check</div>
      <div class="flex items-center gap-2"><ion-icon name="checkmark-circle"
          style="color:#10b981;"></ion-icon>Bouwkundige Disclaimer</div>
      <div class="flex items-center gap-2"><ion-icon name="checkmark-circle" style="color:#10b981;"></ion-icon>PDF
        Export</div>
    </div>
  </div>
  <!--===DASHBOARD SCREEN===-->
  <div id="dashboard-screen" class="dashboard-layout hidden">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="brand"><ion-icon name="home" style="color: #3b82f6;"></ion-icon>AI Woning </div>
      <div style="margin-bottom: 2rem;">
        <div
          style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: #94a3b8; margin-bottom: 1rem;">
          Rapport Secties</div>
        <nav id="chapter-nav">
          <!-- Nav items injected here -->
        </nav>
      </div>
      <div style="margin-top: auto;"><button id="btn-download-pdf" class="hero-btn"
          style="background: white; color: #0f172a; border: 1px solid #e2e8f0; margin-bottom: 1rem;"><ion-icon
            name="document-text-outline"></ion-icon>PDF Downloaden </button><button class="hero-btn"
          onclick="location.reload()" style="background: #3b82f6;"><ion-icon name="add-circle-outline"></ion-icon>Nieuwe
          Analyse </button><a href="/preferences" class="hero-btn"
          style="background: transparent; border: 1px solid #cbd5e1; color: #64748b; margin-top: 0.5rem; text-align: center; text-decoration: none; display: flex; justify-content: center; align-items: center; gap: 0.5rem;"><ion-icon
            name="settings-outline"></ion-icon>Voorkeuren </a></div>
    </aside>
    <!-- Main Content -->
    <main class="main-content">
      <!-- Global Header & Widgets (Restored) -->
      <div class="header-bar hidden">
        <h2 id="d-address"></h2>
        <div id="d-price"></div>
      </div>
      <div id="advisor-area" class="hidden"></div>
      <div id="kpi-area" class="hidden"></div>

      <!-- Report Content -->
      <div id="report-content">
        <div class="chapter-block">
          <h2 class="chapter-title">Rapport wordt gegenereerd...</h2>
          <div class="flex items-center gap-4">
            <div class="spinner"></div>
            <p>Onze AI analyseert momenteel 12 datapunten...</p>
          </div>
        </div>
      </div>
    </main>
  </div>
  <script> // Global function to ensure access

    function togglePasteArea(e) {
      if (e) e.preventDefault();
      const pasteArea = document.getElementById('paste-area');
      if (pasteArea) pasteArea.classList.toggle('hidden');
    }

    document.addEventListener('DOMContentLoaded', () => {

      let currentRunId = null;
      let cachedData = null;

      // Removed duplicate listener for togglePaste to avoid confusion

      const btnDownloadPdf = document.getElementById('btn-download-pdf');

      if (btnDownloadPdf) {
        btnDownloadPdf.addEventListener('click', () => {
          if (!currentRunId) return;

          window.open(`/runs/${currentRunId}/pdf`, '_blank');
        });
      }

      async function createRun(url) {
        const res = await fetch('/runs', {

          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }

          ,
          body: JSON.stringify({
            funda_url: url
          })
        });
        return await res.json();
      }

      const btnStart = document.getElementById('btn-start');

      if (btnStart) {
        btnStart.addEventListener('click', async () => {
          const urlInput = document.getElementById('fc-url');
          const url = urlInput ? urlInput.value : "";

          if (!url) return alert("Voer eerst een URL in.");

          btnStart.innerHTML = "<ion-icon name='sync-outline' class='animate-spin'></ion-icon> Bezig...";
          btnStart.disabled = true;

          try {
            const data = await createRun(url);
            currentRunId = data.run_id;

            await fetch(`/runs/${currentRunId}/start`, { method: 'POST' });
            pollStatus();
          }

          catch (e) {
            alert("Er ging iets mis: " + e.message);
            btnStart.innerText = "Start Analyse";
            btnStart.disabled = false;
          }
        });
      }

      const btnPasteSubmit = document.getElementById('btn-paste-submit');

      if (btnPasteSubmit) {
        btnPasteSubmit.addEventListener('click', async () => {
          const pasteInput = document.getElementById('fc-paste');
          const html = pasteInput ? pasteInput.value : "";

          if (!html) return alert("Plak eerst de HTML.");

          btnPasteSubmit.innerText = "Verwerken...";
          btnPasteSubmit.disabled = true;

          try {
            if (!currentRunId) {
              const data = await createRun("manual-paste");
              currentRunId = data.run_id;
            }

            const res = await fetch(`/runs/${currentRunId}/paste`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              }

              ,
              body: JSON.stringify({
                funda_html: html
              })
            });
            const d = await res.json();

            if (d.ok) {
              showDashboard();
              cachedData = d;
              renderDashboard(d); // Now robust against missing elements
            }

            else {
              alert("Fout: " + (d.error || d.detail || JSON.stringify(d)));
              btnPasteSubmit.innerText = "Verwerk Broncode";
              btnPasteSubmit.disabled = false;
            }
          }

          catch (e) {
            console.error(e);
            alert("Systeemfout: " + e.message);
            btnPasteSubmit.innerText = "Verwerk Broncode";
            btnPasteSubmit.disabled = false;
          }
        });
      }

      async function pollStatus() {
        const interval = setInterval(async () => {
          try {
            if (!currentRunId) return;

            const res = await fetch(`/runs/${currentRunId}/report`);
            const data = await res.json();

            // Fallback Logic
            const pasteArea = document.getElementById('paste-area');
            const btnStart = document.getElementById('btn-start');

            if (data.property_core && data.property_core.scrape_error && pasteArea && pasteArea.classList.contains('hidden')) {

              // Only show if we haven't found data yet
              if (!data.kpis || Object.keys(data.kpis).length === 0) {
                pasteArea.classList.remove('hidden');
                if (btnStart) btnStart.innerHTML = "<ion-icon name='alert-circle-outline'></ion-icon> Mislukt";
                clearInterval(interval);
                return;
              }
            }

            if (data.kpis && Object.keys(data.kpis).length > 0) {
              clearInterval(interval);
              cachedData = data;
              showDashboard();
              renderDashboard(data);
            }
          }

          catch (e) {
            console.error("Poll error", e);
          }
        }

          , 1000);
      }

      function showDashboard() {
        const startScreen = document.getElementById('start-screen');
        const dashboardScreen = document.getElementById('dashboard-screen');
        if (startScreen) startScreen.classList.add('hidden');
        if (dashboardScreen) dashboardScreen.classList.remove('hidden');
        document.body.style.overflow = 'hidden'; // Lock body scroll
      }

      function renderDashboard(data) {
        if (!data) return;

        // Address
        const dAddress = document.getElementById('d-address');
        const dPrice = document.getElementById('d-price');
        if (dAddress) dAddress.innerText = data.property_core.address || "Adres onbekend";
        if (dPrice) dPrice.innerText = data.property_core.asking_price_eur || "Prijs op aanvraag";





        // Chapters Render - TABBED INTERFACE
        const nav = document.getElementById('chapter-nav');
        const content = document.getElementById('report-content');

        if (nav && content) {
          nav.innerHTML = '';
          content.innerHTML = ''; // Clear "Loading..."

          if (!data.chapters) return;

          // 1. Sort chapters 0..12 explicitly
          const sortedKeys = Object.keys(data.chapters).sort((a, b) => parseInt(a) - parseInt(b));

          if (sortedKeys.length === 0) {
            content.innerHTML = `<div class="p-8 text-center text-gray-500" >Geen hoofdstukken gegenereerd.</div>`;
            return;
          }

          // 2. Build DOM
          // 2. Build DOM
          sortedKeys.forEach((key, idx) => {
            const ch = data.chapters[key];

            // A. Nav Item
            const btn = document.createElement('div');
            btn.className = `nav-item ${idx === 0 ? 'active' : ''}`;
            btn.dataset.target = `tab-${key}`;

            // Special styling for Resume (Chapter 0)
            if (parseInt(key) === 0) {
              btn.innerHTML = `<div class="nav-number" style="background:var(--primary-dark); color:white;"><ion-icon name="stats-chart"></ion-icon></div> <span class="nav-label" style="font-weight:700;">Samenvatting</span> <ion-icon name="chevron-forward" class="nav-arrow"></ion-icon>`;
            } else {
              btn.innerHTML = `<span class="nav-number">${key}</span> <span class="nav-label">${ch.title.replace(/^\d+\.\s*/, '')}</span> <ion-icon name="chevron-forward" class="nav-arrow"></ion-icon>`;
            }

            btn.onclick = () => switchTab(key);
            nav.appendChild(btn);

            // B. Content Tab (All hidden except first)
            const tab = document.createElement('div');
            // Ensure first item is active, others hidden
            tab.className = `chapter-tab animate-fade ${idx === 0 ? 'active' : 'hidden'}`;
            tab.id = `tab-${key}`;

            if (parseInt(key) === 0) {
              // Page 0 Treatment
            }

            // Modern Grid Layout
            if (ch.grid_layout) {
              const d = ch.grid_layout;
              // Initialize core data BEFORE using it in templates
              const core = data.property_core || {};

              // 1. Hero Section
              const heroHtml = `<div class="dash-hero">
                  <div class="dash-hero-content">
                    <div class="dash-hero-badge">${d.hero.status || 'Analyse Gereed'}</div>
                    <h1 class="dash-hero-title">${d.hero.address || 'Adres Onbekend'}</h1>
                    <div class="dash-hero-subtitle">
                      <span style="font-weight: 600; color: #0f172a;">${d.hero.price || ''}</span>
                      ${(d.hero.labels || []).map(label => `<span style="opacity:0.6;">•</span> <span>${label}</span>`).join(' ')}
                    </div>
                  </div>
                  <div class="dash-hero-meta">
                    <div class="dash-hero-meta-item">
                      <div class="dash-hero-meta-label">Bouwjaar</div>
                      <div class="dash-hero-meta-value">${core.build_year || '-'}</div>
                    </div>
                    <div class="dash-hero-meta-item">
                      <div class="dash-hero-meta-label">Woonoppervlak</div>
                      <div class="dash-hero-meta-value">${core.living_area_m2 || '-'}</div>
                    </div>
                    <div class="dash-hero-meta-item">
                      <div class="dash-hero-meta-label">Perceel</div>
                      <div class="dash-hero-meta-value">${core.plot_area_m2 || '-'}</div>
                    </div>
                    <div class="dash-hero-meta-item">
                      <div class="dash-hero-meta-label">Energie</div>
                      <div class="dash-hero-meta-value">${core.energy_label || '-'}</div>
                    </div>
                  </div>
                </div>`;

              // 2. Metrics Row
              let metricsHtml = '';
              (d.metrics || []).forEach(m => {
                // Determine semantic color class
                let colorClass = 'text-blue-600';
                let metricClass = '';
                if (m.color === 'green') {
                  colorClass = 'text-green-600';
                  metricClass = 'metric-good';
                } else if (m.color === 'orange' || m.color === 'yellow') {
                  colorClass = 'text-orange-500';
                  metricClass = 'metric-caution';
                } else if (m.color === 'red') {
                  colorClass = 'text-red-600';
                  metricClass = 'metric-bad';
                }

                // Add explanation badge if provided
                let explanationHtml = '';
                if (m.explanation) {
                  let explanationClass = 'good';
                  if (m.color === 'orange' || m.color === 'yellow') {
                    explanationClass = 'caution';
                  } else if (m.color === 'red') {
                    explanationClass = 'bad';
                  }
                  explanationHtml = `<div class="color-explanation ${explanationClass}">
                    <ion-icon name="${m.color === 'green' ? 'checkmark-circle' : m.color === 'red' ? 'close-circle' : 'alert-circle'}"></ion-icon>
                    ${m.explanation}
                  </div>`;
                }

                metricsHtml += `<div class="dash-metric-card ${metricClass}">
                    <div class="dash-metric-icon"><ion-icon name="${m.icon}"></ion-icon></div>
                    <div>
                      <div class="dash-metric-label">${m.label}</div>
                      <div class="dash-metric-value ${colorClass}">${m.value}</div>
                      ${explanationHtml}
                    </div>
                  </div>`;
              });

              // 3. 3-Column Content Layout

              // LEFT COLUMN: Chapter-specific or minimal default
              let leftHtml = '';

              // Debug: Log what we're receiving
              console.log(`Chapter ${key} - left_sidebar:`, d.left_sidebar);

              if (d.left_sidebar && d.left_sidebar.length > 0) {
                // Use chapter-specific left sidebar content
                console.log(`✓ Rendering chapter-specific left sidebar for Chapter ${key}`);
                d.left_sidebar.forEach(item => {
                  if (item.type === 'info_card') {
                    leftHtml += `<div class="dash-sidebar-card">
                      <h4 class="mb-3 font-bold text-slate-700">${item.title}</h4>
                      <div class="text-sm text-slate-600">${item.content}</div>
                    </div>`;
                  } else if (item.type === 'key_facts') {
                    const factsHtml = item.facts.map(f =>
                      `<li class="flex justify-between border-b pb-2"><span>${f.label}</span> <span class="font-bold text-slate-800">${f.value}</span></li>`
                    ).join('');
                    leftHtml += `<div class="dash-sidebar-card">
                      <h4 class="mb-3 font-bold text-slate-700">${item.title}</h4>
                      <ul class="space-y-3 text-sm text-slate-600" style="list-style:none; padding:0;">${factsHtml}</ul>
                    </div>`;
                  } else if (item.type === 'highlight_card') {
                    leftHtml += `<div class="dash-sidebar-card gradient-card">
                      <h4 class="flex items-center gap-2 mb-2 font-bold"><ion-icon name="${item.icon || 'information-circle'}"></ion-icon> ${item.title}</h4>
                      <div class="text-sm opacity-90">${item.content}</div>
                    </div>`;
                  } else if (item.type === 'stat_list') {
                    const statsHtml = item.stats.map(s =>
                      `<div class="flex items-center justify-between py-2 border-b">
                        <div class="flex items-center gap-2">
                          <ion-icon name="${s.icon}" class="text-blue-500"></ion-icon>
                          <span class="text-sm">${s.label}</span>
                        </div>
                        <span class="font-bold text-slate-800">${s.value}</span>
                      </div>`
                    ).join('');
                    leftHtml += `<div class="dash-sidebar-card">
                      <h4 class="mb-3 font-bold text-slate-700">${item.title}</h4>
                      ${statsHtml}
                    </div>`;
                  }
                });
              } else {
                // Fallback: Only show if chapter doesn't provide custom content
                console.warn(`⚠ Using fallback Kerngegevens for Chapter ${key} - no left_sidebar data provided`);
                leftHtml = `
                  <div class="dash-sidebar-card">
                     <h4 class="mb-3 font-bold text-slate-700">Kerngegevens</h4>
                     <ul class="space-y-2 text-sm text-slate-600" style="list-style:none; padding:0;">
                        <li class="flex justify-between pb-2"><span>Bouwjaar</span> <span class="font-bold">${core.build_year || '-'}</span></li>
                        <li class="flex justify-between pb-2"><span>Wonen</span> <span class="font-bold">${core.living_area_m2 || '-'}</span></li>
                        <li class="flex justify-between pb-2"><span>Label</span> <span class="font-bold">${core.energy_label || '-'}</span></li>
                     </ul>
                  </div>
                `;
              }


              // CENTER COLUMN: New Magazine Layout
              // 1. Render the Main Content (which contains the full Mag Layout HTML from backend)
              const mainHtml = `<div class="dash-main-card mega-grid" style="padding: 1.5rem;">
                  <h3 class="dash-section-title">${d.main.title}</h3>
                  <div id="mag-content-root">
                    ${d.main.content} 
                  </div>
                </div>`;

              tab.innerHTML = `<div class="dash-wrapper">
                  ${heroHtml}
                  <div class="dash-metrics-grid">${metricsHtml}</div>
                  <div class="dash-content-grid">
                    <div class="dash-col-left">${leftHtml}</div>
                    <div class="dash-col-main">${mainHtml}</div>
                  </div>
                </div>`;

              // 2. DYNAMICALLY INJECT SIDEBAR WIDGETS INTO THE VISUAL COL
              // We wait for DOM update then move items
              setTimeout(() => {
                const visualCol = document.querySelector('.mag-col-visuals');
                if (visualCol && d.sidebar && d.sidebar.length > 0) {
                  d.sidebar.forEach(item => {
                    let widgetHtml = '';
                    if (item.type === 'advisor_score') {
                      widgetHtml = `<div class="mag-widget-card">
                                <div class="flex justify-between items-center mb-2">
                                    <div class="mag-widget-title" style="margin:0">${item.title}</div>
                                    <div class="dash-score-badge">${item.score}%</div>
                                </div>
                                <div class="text-sm text-slate-500 mb-2">${item.content}</div>
                                <div class="dash-progress-bar"><div style="width: ${item.score}%"></div></div>
                            </div>`;
                    } else if (item.type === 'advisor_card') {
                      widgetHtml = `<div class="mag-widget-card" style="border-left: 4px solid #3b82f6;">
                                <h4 class="mag-widget-title text-blue-600"><ion-icon name="bulb"></ion-icon> ${item.title}</h4>
                                <div class="text-sm text-slate-600">${item.content}</div>
                            </div>`;
                    } else if (item.type === 'action_list') {
                      const listItems = item.items.map(i => `<div class="mag-feature-item">
                                <div class="mag-icon-box" style="background:#f1f5f9; color:#64748b"><ion-icon name="checkbox-outline"></ion-icon></div>
                                <span class="mag-feature-text">${i}</span>
                            </div>`).join('');
                      widgetHtml = `<div class="mag-widget-card">
                                <h4 class="mag-widget-title text-slate-700">${item.title}</h4>
                                <div class="mag-feature-grid">${listItems}</div>
                            </div>`;
                    }

                    // Append to visual col
                    if (widgetHtml) visualCol.insertAdjacentHTML('beforeend', widgetHtml);
                  });
                }
              }, 0);
            } else {
              // Fallback Legacy Layout
              tab.innerHTML = `<div class="chapter-header"><span class="chapter-kicker">Hoofdstuk ${key}</span><h2 class="chapter-title-large">${ch.title.replace(/^\d+\.\s*/, '')}</h2></div><div class="chapter-body prose"></div>`;
              const body = tab.querySelector('.chapter-body');

              (ch.blocks || []).forEach(b => {
                if (b.type === 'paragraph') {
                  const textContent = (b.data.text || "").replace(/\n/g, '<br>');
                  body.innerHTML += `<div class="content-block">${textContent}</div>`;
                }
              });
            }

            content.appendChild(tab);
          });

          // Force initial state consistency (e.g. hiding headers for Chapter 0)
          if (sortedKeys.length > 0) {
            switchTab(sortedKeys[0]);
          }
        }
      }

      function switchTab(key) {
        // Update Nav
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        const navBtn = document.querySelector(`.nav-item[data-target="tab-${key}"]`);
        if (navBtn) navBtn.classList.add('active');

        // Update Content
        document.querySelectorAll('.chapter-tab').forEach(el => {
          el.classList.remove('active');
          el.classList.add('hidden'); // Force hide
        });

        const tab = document.getElementById(`tab-${key}`);

        if (tab) {
          tab.classList.remove('hidden'); // Unhide
          tab.classList.add('active'); // Activate (trigger animation/styles)

          // Header Logic: Hide top bar for Chapter 0 (Executive Summary)
          // We hide the standard dashboard header, advisor panel, and KPI grid for Chapter 0
          // because Chapter 0 has its own bespoke "Executive Summary" layout.
          const globalElements = [document.querySelector('.header-bar'),
          document.getElementById('advisor-area'),
          document.getElementById('kpi-area')];

          if (parseInt(key) === 0) {
            globalElements.forEach(el => !el || el.classList.add('hidden'));
          }

          else {
            globalElements.forEach(el => !el || el.classList.remove('hidden'));
          }

          // Reset scroll of main content to top
          const mainContent = document.querySelector('.main-content');
          if (mainContent) mainContent.scrollTop = 0;
        }

        else {
          console.error("Tab not found:", `tab-${key}`);
        }
      }

    });
  </script>
</body>

</html>