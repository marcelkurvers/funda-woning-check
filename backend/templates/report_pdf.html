<!DOCTYPE html>
<html lang="nl">
<!--
    ===============================================================================
    FOUR-PLANE PDF REPORT TEMPLATE
    ===============================================================================
    
    This template MUST render ALL Four Planes or fail loudly.
    
    PLANES:
    üü¶ PLANE A  ‚Äî Visual Intelligence (Deterministic Charts)
    üü¶ PLANE A2 ‚Äî Synthesized Visual Intelligence (Hero Infographics)  
    üü© PLANE B  ‚Äî Narrative Reasoning (Minimum 300 words per chapter)
    üü® PLANE C  ‚Äî Factual Anchor (KPIs with provenance status)
    üü• PLANE D  ‚Äî Human Preference (Marcel & Petra full analysis)
    
    CONTRACT REQUIREMENTS:
    - plane_structure MUST be True for chapters 1-12
    - Plane A2 MUST be visible or explicitly marked as OPERATIONALLY_LIMITED
    - Plane D MUST show 5 positives + 5 concerns per persona
    - Plane C MUST show KPI uncertainty status
    - No truncation of persona analysis
    - No silent degradation
    
    ===============================================================================
-->

<head>
    <meta charset="UTF-8">
    <title>Kurvers Property Consulting - Premium Vastgoedrapport</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800;900&family=Playfair+Display:ital,wght@0,400;0,700;1,400;1,700&family=Inter:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        /* --- GLOBAL & PAGE SETUP --- */
        @page {
            size: A4;
            margin: 0;

            @top-right {
                content: "KURVERS PROPERTY CONSULTING ‚Ä¢ FOUR-PLANE REPORT";
                font-family: 'Outfit', sans-serif;
                font-size: 5.5pt;
                font-weight: 700;
                color: #94a3b8;
                margin-top: 8mm;
                margin-right: 12mm;
                letter-spacing: 2.5px;
            }

            @bottom-right {
                content: "PAGINA " counter(page);
                font-family: 'Outfit', sans-serif;
                font-size: 5.5pt;
                color: #94a3b8;
                margin-bottom: 8mm;
                margin-right: 12mm;
                letter-spacing: 1.5px;
            }
        }

        body {
            font-family: 'Inter', 'Outfit', sans-serif;
            color: #1e293b;
            line-height: 1.6;
            margin: 0;
            font-size: 9.5pt;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }

        .page {
            width: 210mm;
            height: 297mm;
            padding: 0.8cm;
            box-sizing: border-box;
            position: relative;
            page-break-after: always;
            overflow: hidden;
            background: #fff;
        }

        h1,
        h2,
        h3,
        h4 {
            color: #0c121e;
            margin: 0;
            line-height: 1.1;
            font-weight: 800;
        }

        .serif {
            font-family: 'Playfair Display', serif;
            font-style: italic;
        }

        /* --- FOUR-PLANE LAYOUT --- */
        .four-plane-grid {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: 15px;
            height: calc(100% - 80px);
            margin-top: 15px;
        }

        .plane-column {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .plane-box {
            background: #fff;
            border-radius: 12px;
            padding: 12px;
            border: 1px solid #e2e8f0;
        }

        .plane-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            padding-bottom: 8px;
            border-bottom: 2px solid;
        }

        .plane-header-a {
            border-color: #3b82f6;
        }

        .plane-header-a2 {
            border-color: #6366f1;
        }

        .plane-header-b {
            border-color: #10b981;
        }

        .plane-header-c {
            border-color: #f59e0b;
        }

        .plane-header-d {
            border-color: #ef4444;
        }

        .plane-badge {
            font-size: 6pt;
            font-weight: 800;
            padding: 2px 6px;
            border-radius: 4px;
            color: white;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .plane-badge-a {
            background: #3b82f6;
        }

        .plane-badge-a2 {
            background: #6366f1;
        }

        .plane-badge-b {
            background: #10b981;
        }

        .plane-badge-c {
            background: #f59e0b;
        }

        .plane-badge-d {
            background: #ef4444;
        }

        .plane-title {
            font-size: 7pt;
            font-weight: 700;
            color: #475569;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* --- ERROR/STATUS BOXES --- */
        .error-box {
            background: #fef2f2;
            border: 2px solid #ef4444;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            color: #dc2626;
        }

        .error-box h3 {
            color: #dc2626;
            margin-bottom: 10px;
        }

        .warning-box {
            background: #fffbeb;
            border: 2px solid #f59e0b;
            border-radius: 8px;
            padding: 12px;
            color: #b45309;
            font-size: 8pt;
        }

        .limited-box {
            background: #fef3c7;
            border: 2px dashed #d97706;
            border-radius: 8px;
            padding: 12px;
            color: #92400e;
            font-size: 8pt;
        }

        .limited-badge {
            display: inline-block;
            background: #d97706;
            color: white;
            font-size: 6pt;
            font-weight: 800;
            padding: 2px 8px;
            border-radius: 4px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        /* --- CHAPTER HEADER --- */
        .chapter-header {
            display: flex;
            align-items: flex-start;
            gap: 20px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e2e8f0;
        }

        .chapter-number {
            font-size: 48pt;
            font-weight: 900;
            color: #3b82f6;
            line-height: 1;
            font-family: 'Outfit', sans-serif;
        }

        .chapter-info {
            flex: 1;
        }

        .chapter-tag {
            font-size: 6pt;
            font-weight: 800;
            color: #3b82f6;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 4px;
            display: block;
        }

        .chapter-title {
            font-size: 22pt;
            font-weight: 800;
            color: #0c121e;
            line-height: 1.1;
        }

        /* --- PLANE A: CHARTS --- */
        .chart-container {
            background: #f8fafc;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
        }

        .chart-title {
            font-size: 7pt;
            font-weight: 700;
            color: #475569;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .bar-chart {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .bar-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .bar-label {
            font-size: 7pt;
            color: #64748b;
            width: 60px;
            flex-shrink: 0;
        }

        .bar-track {
            flex: 1;
            height: 12px;
            background: #e2e8f0;
            border-radius: 6px;
            overflow: hidden;
        }

        .bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #1d4ed8);
            border-radius: 6px;
            transition: width 0.3s;
        }

        .bar-value {
            font-size: 7pt;
            font-weight: 700;
            color: #1e293b;
            width: 50px;
            text-align: right;
        }

        /* --- PLANE A2: INFOGRAPHICS --- */
        .infographic-box {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 1px solid #bae6fd;
            border-radius: 10px;
            padding: 12px;
        }

        .concept-item {
            background: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 8px;
        }

        .concept-title {
            font-size: 8pt;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 4px;
        }

        .concept-type {
            font-size: 6pt;
            color: #6366f1;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .concept-insight {
            font-size: 7pt;
            color: #64748b;
            margin-top: 6px;
            line-height: 1.4;
        }

        /* --- PLANE B: NARRATIVE --- */
        .narrative-content {
            font-size: 9pt;
            color: #334155;
            line-height: 1.7;
            text-align: justify;
        }

        .narrative-content p {
            margin: 0 0 12px 0;
        }

        .word-count-badge {
            display: inline-block;
            background: #10b981;
            color: white;
            font-size: 6pt;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 4px;
            margin-left: 8px;
        }

        /* --- PLANE C: KPIs --- */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .kpi-card {
            background: #f8fafc;
            border-radius: 8px;
            padding: 10px;
            border-left: 3px solid;
        }

        .kpi-card.status-fact {
            border-color: #10b981;
        }

        .kpi-card.status-inferred {
            border-color: #f59e0b;
        }

        .kpi-card.status-unknown {
            border-color: #ef4444;
        }

        .kpi-label {
            font-size: 6pt;
            font-weight: 700;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .kpi-value {
            font-size: 11pt;
            font-weight: 800;
            color: #1e293b;
        }

        .kpi-status {
            font-size: 5pt;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 3px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 4px;
            display: inline-block;
        }

        .kpi-status.fact {
            background: #d1fae5;
            color: #047857;
        }

        .kpi-status.inferred {
            background: #fef3c7;
            color: #b45309;
        }

        .kpi-status.unknown {
            background: #fecaca;
            color: #dc2626;
        }

        .missing-data-box {
            background: #fff7ed;
            border: 1px dashed #fb923c;
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
        }

        .missing-data-title {
            font-size: 6pt;
            font-weight: 700;
            color: #c2410c;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }

        .missing-data-item {
            font-size: 7pt;
            color: #9a3412;
            margin-bottom: 3px;
        }

        /* --- PLANE D: PERSONA --- */
        .persona-section {
            margin-bottom: 15px;
        }

        .persona-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 8px;
        }

        .persona-header.marcel {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border-left: 4px solid #3b82f6;
        }

        .persona-header.petra {
            background: linear-gradient(135deg, #fdf2f8 0%, #fce7f3 100%);
            border-left: 4px solid #ec4899;
        }

        .persona-name {
            font-size: 10pt;
            font-weight: 800;
            color: #1e293b;
        }

        .persona-score {
            font-size: 14pt;
            font-weight: 900;
            margin-left: auto;
        }

        .persona-score.marcel {
            color: #3b82f6;
        }

        .persona-score.petra {
            color: #ec4899;
        }

        .persona-mood {
            font-size: 6pt;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 4px;
            text-transform: uppercase;
        }

        .mood-positive {
            background: #d1fae5;
            color: #047857;
        }

        .mood-negative {
            background: #fecaca;
            color: #dc2626;
        }

        .mood-neutral {
            background: #f1f5f9;
            color: #475569;
        }

        .mood-mixed {
            background: #fef3c7;
            color: #b45309;
        }

        .persona-list {
            margin: 0;
            padding: 0;
            list-style: none;
        }

        .persona-list-section {
            margin-bottom: 10px;
        }

        .persona-list-title {
            font-size: 6pt;
            font-weight: 700;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }

        .persona-list li {
            font-size: 7.5pt;
            color: #334155;
            padding: 4px 0;
            padding-left: 12px;
            position: relative;
            line-height: 1.4;
        }

        .persona-list li::before {
            content: "‚Ä¢";
            position: absolute;
            left: 0;
            font-weight: bold;
        }

        .persona-list.positives li {
            color: #047857;
        }

        .persona-list.positives li::before {
            color: #10b981;
        }

        .persona-list.concerns li {
            color: #b45309;
        }

        .persona-list.concerns li::before {
            color: #f59e0b;
        }

        .overlap-tensions-box {
            background: #f8fafc;
            border-radius: 8px;
            padding: 12px;
            margin-top: 15px;
        }

        .overlap-section,
        .tension-section {
            margin-bottom: 12px;
        }

        .overlap-title,
        .tension-title {
            font-size: 6pt;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }

        .overlap-title {
            color: #047857;
        }

        .tension-title {
            color: #dc2626;
        }

        .overlap-item,
        .tension-item {
            font-size: 7pt;
            padding: 6px 10px;
            border-radius: 6px;
            margin-bottom: 4px;
        }

        .overlap-item {
            background: #d1fae5;
            color: #047857;
        }

        .tension-item {
            background: #fecaca;
            color: #dc2626;
        }

        /* --- COVER PAGE --- */
        .cover-page {
            padding: 0;
            background: linear-gradient(135deg, #0c121e 0%, #1e3a8a 50%, #0c121e 100%);
            display: flex;
            flex-direction: column;
        }

        .cover-visual {
            flex: 1;
            position: relative;
            min-height: 50%;
        }

        .cover-gradient {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 100%;
            background: linear-gradient(to top, #0c121e 30%, transparent 100%);
        }

        .cover-content {
            padding: 2cm;
            color: white;
        }

        .brand-name {
            font-size: 8pt;
            font-weight: 700;
            letter-spacing: 4px;
            color: #60a5fa;
            text-transform: uppercase;
            margin-bottom: 20px;
        }

        .report-title {
            font-size: 48pt;
            font-weight: 900;
            line-height: 1;
            margin-bottom: 30px;
        }

        .property-address {
            font-size: 14pt;
            color: #94a3b8;
            margin-bottom: 40px;
        }

        .cover-footer {
            display: flex;
            gap: 30px;
            padding-top: 30px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .footer-stat label {
            font-size: 6pt;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: block;
            margin-bottom: 4px;
        }

        .footer-stat span {
            font-size: 12pt;
            font-weight: 700;
            color: white;
        }

        /* --- DIAGNOSTICS PAGE --- */
        .diagnostics-box {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }

        .diagnostics-title {
            font-size: 7pt;
            font-weight: 700;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }

        .diagnostics-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            font-size: 7pt;
            border-bottom: 1px solid #f1f5f9;
        }

        .diagnostics-label {
            color: #64748b;
        }

        .diagnostics-value {
            font-weight: 600;
        }

        .diagnostics-value.ok {
            color: #10b981;
        }

        .diagnostics-value.warning {
            color: #f59e0b;
        }

        .diagnostics-value.error {
            color: #ef4444;
        }

        /* --- PHOTO GRID --- */
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin: 15px 0;
        }

        .photo-grid-item {
            aspect-ratio: 4/3;
            overflow: hidden;
            border-radius: 8px;
            background: #f1f5f9;
        }

        .photo-grid-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* --- FOOTER --- */
        .page-footer {
            position: absolute;
            bottom: 0.8cm;
            left: 0.8cm;
            right: 0.8cm;
            display: flex;
            justify-content: space-between;
            border-top: 1px solid #f1f5f9;
            padding-top: 10px;
            font-size: 6pt;
            color: #94a3b8;
        }
    </style>
</head>

<body>

    <!-- ===================================================================
         COVER PAGE
         =================================================================== -->
    <div class="page cover-page">
        <div class="cover-visual"
            style="background: {% if property_core.media_urls %}url('{{ property_core.media_urls[0] }}'){% else %}linear-gradient(135deg, #1e3a8a, #0c121e){% endif %} center/cover no-repeat;">
            <div class="cover-gradient"></div>
        </div>
        <div class="cover-content">
            <div class="brand-name">Kurvers Property Consulting</div>
            <h1 class="report-title">PREMIUM<br><span class="serif">Vastgoed Analyse.</span></h1>
            <div class="property-address">{{ property_core.address }}</div>

            <div class="cover-footer">
                <div class="footer-stat">
                    <label>Investering</label>
                    <span>{{ property_core.asking_price_eur }}</span>
                </div>
                <div class="footer-stat">
                    <label>Woonoppervlak</label>
                    <span>{{ property_core.living_area_m2 or '0' }} m¬≤</span>
                </div>
                <div class="footer-stat">
                    <label>Bouwjaar</label>
                    <span>{{ property_core.build_year or 'Onbekend' }}</span>
                </div>
                <div class="footer-stat">
                    <label>Energielabel</label>
                    <span>{{ property_core.energy_label or 'N/B' }}</span>
                </div>
                <div class="footer-stat">
                    <label>Rapport Datum</label>
                    <span>{{ date }}</span>
                </div>
            </div>
        </div>
    </div>

    <!-- ===================================================================
         CORE SUMMARY PAGE
         =================================================================== -->
    {% if core_summary %}
    <div class="page">
        <div class="chapter-header">
            <div class="chapter-info">
                <span class="chapter-tag">Kernoverzicht</span>
                <h1 class="chapter-title">Samenvatting Kerngegevens</h1>
            </div>
        </div>

        <div class="kpi-grid" style="grid-template-columns: repeat(4, 1fr); margin-bottom: 20px;">
            <div class="kpi-card status-{{ core_summary.asking_price.status }}">
                <div class="kpi-label">Vraagprijs</div>
                <div class="kpi-value">{{ core_summary.asking_price.value }}</div>
                <span class="kpi-status {{ core_summary.asking_price.status }}">{{ core_summary.asking_price.status
                    }}</span>
            </div>
            <div class="kpi-card status-{{ core_summary.living_area.status }}">
                <div class="kpi-label">Woonoppervlak</div>
                <div class="kpi-value">{{ core_summary.living_area.value }}</div>
                <span class="kpi-status {{ core_summary.living_area.status }}">{{ core_summary.living_area.status
                    }}</span>
            </div>
            <div class="kpi-card status-{{ core_summary.location.status }}">
                <div class="kpi-label">Locatie</div>
                <div class="kpi-value">{{ core_summary.location.value }}</div>
                <span class="kpi-status {{ core_summary.location.status }}">{{ core_summary.location.status }}</span>
            </div>
            <div class="kpi-card status-{{ core_summary.match_score.status }}">
                <div class="kpi-label">Match Score</div>
                <div class="kpi-value">{{ core_summary.match_score.value }}</div>
                <span class="kpi-status {{ core_summary.match_score.status }}">{{ core_summary.match_score.status
                    }}</span>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- ===================================================================
         TABLE OF CONTENTS
         =================================================================== -->
    <div class="page">
        <div class="chapter-header">
            <div class="chapter-info">
                <span class="chapter-tag">Rapportage Structuur</span>
                <h1 class="chapter-title serif">Inhoudsopgave</h1>
            </div>
        </div>

        <div style="margin-top: 30px;">
            {% for ch in chapters %}
            <div
                style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 12px; border-bottom: 1px dotted #e2e8f0; padding-bottom: 8px;">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <span style="font-size: 10pt; font-weight: 800; color: #3b82f6; width: 30px;">{{ '%02d' %
                        loop.index0 }}</span>
                    <span style="font-size: 10pt; color: #1a1a1a;">{{ ch.title }}</span>
                    {% if ch.plane_structure %}
                    <span
                        style="font-size: 5pt; background: #10b981; color: white; padding: 2px 6px; border-radius: 3px; font-weight: 700;">4-PLANE</span>
                    {% endif %}
                </div>
                <span style="font-size: 8pt; color: #94a3b8;">{{ loop.index + 2 }}</span>
            </div>
            {% endfor %}
        </div>

        <div
            style="margin-top: 40px; padding: 20px; border: 1px solid #f1f5f9; border-radius: 12px; background: #f8fafc;">
            <h4
                style="font-size: 7pt; letter-spacing: 2px; color: #3b82f6; text-transform: uppercase; margin-bottom: 10px;">
                Leeswijzer ‚Äî Four-Plane Architecture</h4>
            <p style="font-size: 8pt; color: #64748b; line-height: 1.6;">
                Dit rapport is opgebouwd volgens de Four-Plane architectuur. Elk hoofdstuk bevat:
                <br><strong>üü¶ Plane A ‚Äî Visuele analyse</strong> (grafieken, trends)
                <br><strong>üü¶ Plane A2 ‚Äî Infographics</strong> (gesynthetiseerde visualisaties)
                <br><strong>üü© Plane B ‚Äî Narratief</strong> (uitleg en interpretatie)
                <br><strong>üü® Plane C ‚Äî Feiten</strong> (KPIs met zekerheidsgraad)
                <br><strong>üü• Plane D ‚Äî Persona analyse</strong> (Marcel & Petra match)
            </p>
        </div>
    </div>

    <!-- ===================================================================
         CHAPTERS - FOUR-PLANE RENDERING
         =================================================================== -->
    {% for ch in chapters %}

    {# === GUARD: plane_structure MUST be True for chapters 1-12 === #}
    {% set chapter_id = ch.id|int if ch.id is defined else loop.index0 %}
    {% set requires_four_plane = chapter_id >= 1 and chapter_id <= 12 %} {% set has_four_plane=ch.plane_structure is
        defined and ch.plane_structure==true %} {% if requires_four_plane and not has_four_plane %} <!-- CONTRACTBREUK:
        Chapter {{ chapter_id }} missing plane_structure -->
        <div class="page">
            <div class="error-box" style="margin-top: 100px;">
                <h3>‚õî FOUR-PLANE CONTRACT VIOLATION</h3>
                <p style="font-size: 10pt; margin: 20px 0;">
                    Hoofdstuk {{ chapter_id }} (<strong>{{ ch.title }}</strong>) heeft geen valide Four-Plane structuur.
                </p>
                <div style="text-align: left; background: #fff; padding: 20px; border-radius: 8px; margin-top: 20px;">
                    <p style="font-size: 8pt; color: #64748b; margin-bottom: 10px;">
                        <strong>Contract Requirement:</strong> plane_structure = True
                    </p>
                    <p style="font-size: 8pt; color: #64748b; margin-bottom: 10px;">
                        <strong>Actual Value:</strong> {{ ch.plane_structure | default('MISSING') }}
                    </p>
                    <p style="font-size: 8pt; color: #64748b;">
                        Dit hoofdstuk kan niet worden gerenderd zonder valide Four-Plane data.
                        Check de backend pipeline en/of regenereer het rapport.
                    </p>
                </div>
            </div>
        </div>

        {% else %}

        <div class="page">
            <!-- Chapter Header -->
            <div class="chapter-header">
                <div class="chapter-number">{{ '%02d' % chapter_id }}</div>
                <div class="chapter-info">
                    <span class="chapter-tag">{{ ch.segment | default('Strategische Analyse') }}</span>
                    <h1 class="chapter-title">{{ ch.title }}</h1>
                </div>
            </div>

            <!-- FOUR-PLANE GRID LAYOUT -->
            {% if has_four_plane %}
            <div class="four-plane-grid">

                <!-- LEFT COLUMN: PLANE A + PLANE A2 -->
                <div class="plane-column">

                    <!-- PLANE A: Deterministic Visuals -->
                    <div class="plane-box">
                        <div class="plane-header plane-header-a">
                            <span class="plane-badge plane-badge-a">A</span>
                            <span class="plane-title">Visual Intelligence</span>
                        </div>

                        {% if ch.plane_a and ch.plane_a.charts %}
                        {% for chart in ch.plane_a.charts %}
                        <div class="chart-container">
                            <div class="chart-title">{{ chart.title }}</div>

                            {% if chart.chart_type == 'bar' %}
                            <div class="bar-chart">
                                {% for dp in chart.data[:6] %}
                                <div class="bar-item">
                                    <span class="bar-label">{{ dp.label[:10] }}</span>
                                    <div class="bar-track">
                                        <div class="bar-fill"
                                            style="width: {{ (dp.value / (chart.max_value or 100)) * 100 }}%;"></div>
                                    </div>
                                    <span class="bar-value">{{ dp.value }}{{ dp.unit or '' }}</span>
                                </div>
                                {% endfor %}
                            </div>

                            {% elif chart.chart_type == 'gauge' %}
                            <div style="text-align: center; padding: 15px;">
                                <div style="font-size: 28pt; font-weight: 900; color: #3b82f6;">
                                    {{ chart.data[0].value if chart.data else 'N/A' }}
                                </div>
                                <div style="font-size: 7pt; color: #64748b;">{{ chart.data[0].label if chart.data else
                                    '' }}</div>
                            </div>

                            {% else %}
                            <!-- Fallback: Table representation -->
                            <table style="width: 100%; font-size: 7pt;">
                                {% for dp in chart.data[:6] %}
                                <tr>
                                    <td style="padding: 4px 0; color: #64748b;">{{ dp.label }}</td>
                                    <td style="padding: 4px 0; text-align: right; font-weight: 700;">{{ dp.value }}{{
                                        dp.unit or '' }}</td>
                                </tr>
                                {% endfor %}
                            </table>
                            {% endif %}
                        </div>
                        {% endfor %}
                        {% elif ch.plane_a and ch.plane_a.not_applicable %}
                        <div class="warning-box">
                            <strong>Niet van toepassing:</strong> {{ ch.plane_a.not_applicable_reason | default('Geen
                            visuele data beschikbaar') }}
                        </div>
                        {% else %}
                        <div class="warning-box">Geen grafieken beschikbaar voor dit hoofdstuk.</div>
                        {% endif %}
                    </div>

                    <!-- PLANE A2: Synthesized Visuals -->
                    <div class="plane-box">
                        <div class="plane-header plane-header-a2">
                            <span class="plane-badge plane-badge-a2">A2</span>
                            <span class="plane-title">Synthesized Intelligence</span>
                        </div>

                        {% if ch.plane_a2 %}
                        {% if ch.plane_a2.not_applicable %}
                        <!-- EXPLICIT NOT APPLICABLE STATE -->
                        <div class="limited-box">
                            <span class="limited-badge">OPERATIONALLY LIMITED</span>
                            <p style="margin: 0; font-size: 7pt;">
                                {{ ch.plane_a2.not_applicable_reason | default('AI visuele synthese is tijdelijk
                                beperkt.') }}
                            </p>
                        </div>
                        {% else %}
                        <!-- Hero Infographic -->
                        {% if ch.plane_a2.hero_infographic %}
                        <div class="infographic-box" style="margin-bottom: 10px;">
                            <div style="font-size: 8pt; font-weight: 700; color: #1e293b; margin-bottom: 6px;">
                                {{ ch.plane_a2.hero_infographic.title }}
                            </div>
                            {% if ch.plane_a2.hero_infographic.image_uri %}
                            <img src="{{ ch.plane_a2.hero_infographic.image_uri }}"
                                alt="{{ ch.plane_a2.hero_infographic.title }}"
                                style="width: 100%; border-radius: 8px; margin-bottom: 8px;">
                            {% endif %}
                            <div style="font-size: 6pt; color: #6366f1; text-transform: uppercase; font-weight: 600;">
                                {{ ch.plane_a2.hero_infographic.visual_type }}
                            </div>
                            {% if ch.plane_a2.hero_infographic.generation_status != 'generated' %}
                            <div style="font-size: 6pt; color: #9ca3af; margin-top: 4px;">
                                Status: {{ ch.plane_a2.hero_infographic.generation_status }}
                                {% if ch.plane_a2.hero_infographic.generation_error %}
                                ‚Äî {{ ch.plane_a2.hero_infographic.generation_error }}
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}

                        <!-- Visual Concepts -->
                        {% if ch.plane_a2.concepts %}
                        {% for concept in ch.plane_a2.concepts[:3] %}
                        <div class="concept-item">
                            <div class="concept-title">{{ concept.title }}</div>
                            <div class="concept-type">{{ concept.visual_type }}</div>
                            <div class="concept-insight">{{ concept.insight_explained[:150] }}{% if
                                concept.insight_explained|length > 150 %}...{% endif %}</div>
                        </div>
                        {% endfor %}
                        {% endif %}
                        {% endif %}
                        {% else %}
                        <!-- FAIL-LOUD: A2 missing entirely -->
                        <div class="error-box" style="padding: 10px;">
                            <p style="font-size: 7pt; margin: 0; color: #dc2626;">
                                <strong>‚ö†Ô∏è Plane A2 data niet aanwezig.</strong><br>
                                Dit is een contractbreuk ‚Äî A2 moet altijd zichtbaar zijn of expliciet gelimiteerd.
                            </p>
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- CENTER COLUMN: PLANE B + PLANE C -->
                <div class="plane-column">

                    <!-- PLANE B: Narrative Reasoning -->
                    <div class="plane-box" style="flex: 2;">
                        <div class="plane-header plane-header-b">
                            <span class="plane-badge plane-badge-b">B</span>
                            <span class="plane-title">Narratieve Duiding</span>
                            {% if ch.plane_b and ch.plane_b.word_count %}
                            <span class="word-count-badge">{{ ch.plane_b.word_count }} woorden</span>
                            {% endif %}
                        </div>

                        {% if ch.plane_b and ch.plane_b.narrative_text %}
                        <div class="narrative-content">
                            {{ ch.plane_b.narrative_text | safe }}
                        </div>
                        {% else %}
                        <div class="error-box" style="padding: 15px;">
                            <p style="font-size: 8pt; margin: 0;">
                                <strong>‚õî Narratief ontbreekt</strong><br>
                                Plane B vereist minimaal 300 woorden narratieve tekst.
                            </p>
                        </div>
                        {% endif %}
                    </div>

                    <!-- PLANE C: Factual Anchor -->
                    <div class="plane-box" style="flex: 1;">
                        <div class="plane-header plane-header-c">
                            <span class="plane-badge plane-badge-c">C</span>
                            <span class="plane-title">Feitelijke Data</span>
                        </div>

                        {% if ch.plane_c and ch.plane_c.kpis %}
                        <div class="kpi-grid">
                            {% for kpi in ch.plane_c.kpis[:8] %}
                            <div class="kpi-card status-{{ kpi.provenance | default('unknown') }}">
                                <div class="kpi-label">{{ kpi.label }}</div>
                                <div class="kpi-value">{{ kpi.value | default('‚Äî') }}{{ kpi.unit or '' }}</div>
                                <span class="kpi-status {{ kpi.provenance | default('unknown') }}">
                                    {{ kpi.provenance | default('unknown') }}
                                </span>
                            </div>
                            {% endfor %}
                        </div>

                        {% if ch.plane_c.missing_data and ch.plane_c.missing_data|length > 0 %}
                        <div class="missing-data-box">
                            <div class="missing-data-title">‚ö†Ô∏è Ontbrekende Data</div>
                            {% for missing in ch.plane_c.missing_data[:4] %}
                            <div class="missing-data-item">‚Ä¢ {{ missing }}</div>
                            {% endfor %}
                        </div>
                        {% endif %}

                        {% if ch.plane_c.uncertainties and ch.plane_c.uncertainties|length > 0 %}
                        <div style="margin-top: 10px; font-size: 6pt; color: #9ca3af;">
                            <strong>Onzekerheden:</strong>
                            {% for unc in ch.plane_c.uncertainties[:3] %}
                            {{ unc }}{% if not loop.last %}, {% endif %}
                            {% endfor %}
                        </div>
                        {% endif %}

                        {% else %}
                        <div class="warning-box">Geen KPIs beschikbaar voor dit hoofdstuk.</div>
                        {% endif %}
                    </div>
                </div>

                <!-- RIGHT COLUMN: PLANE D -->
                <div class="plane-column">
                    <div class="plane-box" style="flex: 1;">
                        <div class="plane-header plane-header-d">
                            <span class="plane-badge plane-badge-d">D</span>
                            <span class="plane-title">Persona Analyse</span>
                        </div>

                        {% if ch.plane_d %}

                        <!-- MARCEL -->
                        <div class="persona-section">
                            <div class="persona-header marcel">
                                <span class="persona-name">Marcel</span>
                                {% if ch.plane_d.marcel.mood %}
                                <span class="persona-mood mood-{{ ch.plane_d.marcel.mood }}">{{ ch.plane_d.marcel.mood
                                    }}</span>
                                {% endif %}
                                {% if ch.plane_d.marcel.match_score %}
                                <span class="persona-score marcel">{{ ch.plane_d.marcel.match_score|round(0)|int
                                    }}</span>
                                {% endif %}
                            </div>

                            <!-- Marcel Positives (5 required) -->
                            {% if ch.plane_d.marcel.key_values and ch.plane_d.marcel.key_values|length > 0 %}
                            <div class="persona-list-section">
                                <div class="persona-list-title">‚úì Positieve Punten</div>
                                <ul class="persona-list positives">
                                    {% for val in ch.plane_d.marcel.key_values[:5] %}
                                    <li>{{ val }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                            {% endif %}

                            <!-- Marcel Concerns (5 required) -->
                            {% if ch.plane_d.marcel.concerns and ch.plane_d.marcel.concerns|length > 0 %}
                            <div class="persona-list-section">
                                <div class="persona-list-title">‚ö† Aandachtspunten</div>
                                <ul class="persona-list concerns">
                                    {% for concern in ch.plane_d.marcel.concerns[:5] %}
                                    <li>{{ concern }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                            {% endif %}

                            <!-- Marcel Summary (no truncation) -->
                            {% if ch.plane_d.marcel.summary %}
                            <div
                                style="font-size: 7pt; color: #475569; font-style: italic; padding: 8px; background: #f1f5f9; border-radius: 6px; margin-top: 8px;">
                                {{ ch.plane_d.marcel.summary }}
                            </div>
                            {% endif %}
                        </div>

                        <!-- PETRA -->
                        <div class="persona-section">
                            <div class="persona-header petra">
                                <span class="persona-name">Petra</span>
                                {% if ch.plane_d.petra.mood %}
                                <span class="persona-mood mood-{{ ch.plane_d.petra.mood }}">{{ ch.plane_d.petra.mood
                                    }}</span>
                                {% endif %}
                                {% if ch.plane_d.petra.match_score %}
                                <span class="persona-score petra">{{ ch.plane_d.petra.match_score|round(0)|int }}</span>
                                {% endif %}
                            </div>

                            <!-- Petra Positives (5 required) -->
                            {% if ch.plane_d.petra.key_values and ch.plane_d.petra.key_values|length > 0 %}
                            <div class="persona-list-section">
                                <div class="persona-list-title">‚úì Positieve Punten</div>
                                <ul class="persona-list positives">
                                    {% for val in ch.plane_d.petra.key_values[:5] %}
                                    <li>{{ val }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                            {% endif %}

                            <!-- Petra Concerns (5 required) -->
                            {% if ch.plane_d.petra.concerns and ch.plane_d.petra.concerns|length > 0 %}
                            <div class="persona-list-section">
                                <div class="persona-list-title">‚ö† Aandachtspunten</div>
                                <ul class="persona-list concerns">
                                    {% for concern in ch.plane_d.petra.concerns[:5] %}
                                    <li>{{ concern }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                            {% endif %}

                            <!-- Petra Summary (no truncation) -->
                            {% if ch.plane_d.petra.summary %}
                            <div
                                style="font-size: 7pt; color: #475569; font-style: italic; padding: 8px; background: #fdf2f8; border-radius: 6px; margin-top: 8px;">
                                {{ ch.plane_d.petra.summary }}
                            </div>
                            {% endif %}
                        </div>

                        <!-- OVERLAPS & TENSIONS -->
                        {% if (ch.plane_d.overlap_points and ch.plane_d.overlap_points|length > 0) or
                        (ch.plane_d.tension_points and ch.plane_d.tension_points|length > 0) %}
                        <div class="overlap-tensions-box">
                            {% if ch.plane_d.overlap_points and ch.plane_d.overlap_points|length > 0 %}
                            <div class="overlap-section">
                                <div class="overlap-title">‚úì Overlap (Beide Eens)</div>
                                {% for overlap in ch.plane_d.overlap_points[:3] %}
                                <div class="overlap-item">{{ overlap }}</div>
                                {% endfor %}
                            </div>
                            {% endif %}

                            {% if ch.plane_d.tension_points and ch.plane_d.tension_points|length > 0 %}
                            <div class="tension-section">
                                <div class="tension-title">‚ö° Spanning (Verschil)</div>
                                {% for tension in ch.plane_d.tension_points[:3] %}
                                <div class="tension-item">{{ tension }}</div>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}

                        {% else %}
                        <div class="error-box" style="padding: 15px;">
                            <p style="font-size: 8pt; margin: 0;">
                                <strong>‚õî Persona data ontbreekt</strong><br>
                                Plane D vereist Marcel & Petra analyse met 5 positives en 5 concerns per persona.
                            </p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            {% else %}
            <!-- LEGACY FALLBACK for Chapter 0 or non-4-plane chapters -->
            <div style="padding: 20px;">
                {% if ch.chapter_data and ch.chapter_data.intro %}
                <p style="font-size: 11pt; color: #64748b; margin-bottom: 20px;">{{ ch.chapter_data.intro | safe }}</p>
                {% endif %}

                {% if ch.chapter_data and ch.chapter_data.main_analysis %}
                <div class="narrative-content">{{ ch.chapter_data.main_analysis | safe }}</div>
                {% elif ch.grid_layout and ch.grid_layout.main %}
                <div class="narrative-content">{{ ch.grid_layout.main.content | safe }}</div>
                {% endif %}
            </div>
            {% endif %}

            <!-- Page Footer -->
            <div class="page-footer">
                <div>{{ property_core.address }}</div>
                <div style="font-weight: 700; color: #3b82f6; letter-spacing: 2px;">KURVERS PROPERTY CONSULTING</div>
            </div>
        </div>

        {% endif %} {# end of plane_structure guard #}
        {% endfor %}

        <!-- ===================================================================
         DIAGNOSTICS PAGE (OPTIONAL - for debugging)
         =================================================================== -->
        <div class="page">
            <div class="chapter-header">
                <div class="chapter-info">
                    <span class="chapter-tag">Technische Verificatie</span>
                    <h1 class="chapter-title">Four-Plane Diagnostics</h1>
                </div>
            </div>

            <div class="diagnostics-box">
                <div class="diagnostics-title">Rapport Metadata</div>
                <div class="diagnostics-row">
                    <span class="diagnostics-label">Gegenereerd op</span>
                    <span class="diagnostics-value">{{ date }}</span>
                </div>
                <div class="diagnostics-row">
                    <span class="diagnostics-label">Run ID</span>
                    <span class="diagnostics-value">{{ run_id }}</span>
                </div>
                <div class="diagnostics-row">
                    <span class="diagnostics-label">Adres</span>
                    <span class="diagnostics-value">{{ property_core.address }}</span>
                </div>
                <div class="diagnostics-row">
                    <span class="diagnostics-label">Totaal Hoofdstukken</span>
                    <span class="diagnostics-value">{{ chapters|length }}</span>
                </div>
            </div>

            <div class="diagnostics-box">
                <div class="diagnostics-title">Four-Plane Status per Hoofdstuk</div>
                {% for ch in chapters %}
                {% set chapter_id = ch.id|int if ch.id is defined else loop.index0 %}
                <div class="diagnostics-row">
                    <span class="diagnostics-label">Hoofdstuk {{ '%02d' % chapter_id }}: {{ ch.title[:30] }}{% if
                        ch.title|length > 30 %}...{% endif %}</span>
                    <span class="diagnostics-value {% if ch.plane_structure %}ok{% else %}error{% endif %}">
                        {% if ch.plane_structure %}
                        ‚úì 4-PLANE OK
                        {% else %}
                        ‚úó LEGACY/MISSING
                        {% endif %}
                    </span>
                </div>
                {% endfor %}
            </div>

            <div class="diagnostics-box">
                <div class="diagnostics-title">Plane Status Legenda</div>
                <div style="display: flex; gap: 20px; flex-wrap: wrap; margin-top: 10px;">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span class="plane-badge plane-badge-a">A</span>
                        <span style="font-size: 7pt;">Visual Intelligence (Charts)</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span class="plane-badge plane-badge-a2">A2</span>
                        <span style="font-size: 7pt;">Synthesized Visuals (AI)</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span class="plane-badge plane-badge-b">B</span>
                        <span style="font-size: 7pt;">Narrative Reasoning</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span class="plane-badge plane-badge-c">C</span>
                        <span style="font-size: 7pt;">Factual Anchor (KPIs)</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <span class="plane-badge plane-badge-d">D</span>
                        <span style="font-size: 7pt;">Human Preference</span>
                    </div>
                </div>
            </div>

            <div style="margin-top: 40px; text-align: center; color: #94a3b8; font-size: 7pt;">
                <p>Dit rapport is gegenereerd met de Four-Plane AI Architecture v2.0</p>
                <p>¬© {{ date.split(' ')[0] if date and ' ' in date else date }} Kurvers Property Consulting ‚Äî Alle
                    rechten voorbehouden</p>
            </div>
        </div>

</body>

</html>