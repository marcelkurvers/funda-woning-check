# Product Requirements Document (PRD) - AI Woning Rapport

**Version**: 1.0  
**Date**: 2025-12-17  
**Status**: Committed / Production Ready

## 1. Executive Summary
The **AI Woning Rapport** is an intelligent property analysis tool designed to provide potential homebuyers (specifically tailored for "Marcel & Petra") with a deep, data-driven, and context-aware report on real estate listings from Funda. Unlike standard listing sites, this tool ingests raw listing data, enhances it with AI-driven insights, checks against personal constraints, and outputs a magazine-style interactive report and a download-ready PDF.

---

## 2. System Architecture & Stack

### 2.1 Technology Stack
-   **Frontend**: React (Vite), TypeScript, Tailwind CSS, Lucide Icons.
-   **Backend**: Python (FastAPI), SQLite (local persistence).
-   **AI/Logic**: `IntelligenceEngine` (Python-based rule engine & heuristic generator, simulating LLM reasoning).
-   **Data Ingestion**: Custom HTML Parser (Regex/BeautifulSoup) for Funda content.
-   **Output**: Interactive Web Dashboard & PDF (WeasyPrint).

### 2.2 Core Workflows
1.  **Ingest**: User supplies a Funda URL or raw HTML.
2.  **Process**: Backend scrapes/parses data -> calculates KPIs -> runs Intelligence Engine for 13 unique chapters.
3.  **Present**: Frontend renders a split-screen layout (Narrative vs. Visual Context) for each chapter.
4.  **Export**: On-demand generation of a professional PDF report.

---

## 3. Page & Feature Specifications

### 3.1 Landing Page (Input)
**Purpose**: Entry point for initiating a new analysis.
-   **Functionality**:
    -   **URL Input**: Field to paste a Funda link (scrapes automatically).
    -   **Paste Mode**: Text area to paste raw HTML source (bypass anti-scraping).
    -   **Action**: "Start Analyse" triggers the backend pipeline.
    -   **Feedback**: Loading spinners and error handling for failed parsing.

### 3.2 Preferences Page (`/preferences`)
**Purpose**: Configure the "Personal Match" logic used in Chapter 2.
-   **Data Structure**: JSON object stored in SQLite (`kv_store`).
-   **User Profiles**:
    -   **Marcel**:
        -   *Priorities*: Tech, Infrastructure, Energy (e.g., "1930s", "Glasvezel", "Zonnepanelen").
        -   *Hidden Priorities*: Weighted factors backend-only.
    -   **Petra**:
        -   *Priorities*: Atmosphere, Comfort, Finish (e.g., "Karakteristiek", "Bad", "Sfeer").
    -   **Custom Inputs**: Text fields to add/remove keywords dynamically.
-   **Requirements**:
    -   Changes must persist immediately or via a "Save" button.
    -   These preferences directly impact the "Score" calculation in Chapter 2.

### 3.3 Report Dashboard (Container)
**Purpose**: The main specific view for a generated report.
-   **Layout**:
    -   **Left Sidebar**: Navigation for Chapters 0-12 + "Instellingen" link. Shows property address and active chapter state.
    -   **Header**: Chapter Number, Title, and "Live Status" indicator.
    -   **Main Content Area**: Split View (Narrative Left | Visual Context Right).

---

### 3.4 Global Page Requirements (Lead AI Architect Update)
**Purpose**: Ensure consistency, transparency, and personalization across all chapters.
-   **Source of Truth**: All chapters must strictly adhere to the technical data extracted by the `Parser`. Contradictory AI interpretations are forbidden.
-   **Preference Comparison Section**: Every chapter must include a "Marcel vs Petra" comparison block that:
    -   Juxtaposes Marcel's tech/infra focus (ROI & TCO) with Petra's atmosphere/comfort focus.
    -   Provides specific advice for each persona based on the chapter's topic.
-   **AI Provenance & Trust**: Every chapter must explicitly surface:
    -   **AI Provider & Model**: Visible in the chapter header.
    -   **Confidence Score**: Indication of analysis reliability.
    -   **Fact vs. Inference**: Clear distinction in the UI between verified Funda data and AI-interpreted insights.
    -   **Proof of Reasoning**: Explanations for why an inference was made.
-   **Missing Data Tracking**: Critical missing variables must be explicitly flagged as "Onbekend" to prevent hallucinations and alert the user.
-   **Non-Repetition**: AI generation must be context-aware to ensure information is unique to the chapter.

---

### 3.5 Detailed Chapter Specifications

Each chapter is generated by the `IntelligenceEngine` with specific heuristic logic.

#### **Chapter 0: Executive Summary (Introductie & Samenvatting)**
-   **Goal**: High-level overview of the property.
-   **Data Inputs**: Address, Price, Area, Energy Label.
-   **Content**:
    -   **Intro**: Welcoming text summarizing the address and asking price.
    -   **Warning**: Automatic detection of missing KPIs (e.g., "Plot size unknown").
    -   **AI Disclaimer**: Explicit statement that the report is AI-generated.
    -   **Visuals**: Key Metrics cards (Ask Price, Living Area, Label).

#### **Chapter 1: General Features (Algemene Woningkenmerken)**
-   **Goal**: Physical characteristics and "Terseness" of the building.
-   **Analysis**:
    -   **Ratio Analysis**: Living area vs. Plot size (Urban vs. Rural density).
    -   **Build Year**: Categorizes into Historic (<1940), Reconstruction (1940-1990), or Modern (>2000).
    -   **Price Segment**: "Starter", "Mid-segment", or "Top-segment" (>1M).
-   **Visuals**: "Sterke Punten" (Pros) and Advice list.

#### **Chapter 2: Personal Match (Matchanalyse M&P)**
-   **Goal**: The "Killer Feature" - linking property data to user personas.
-   **Logic**:
    -   Scans Description & Features for keywords defined in `Preferences`.
    -   **Marcel**: Infrastructure focus (Ethernet, Solar, Garage, Construction Year).
    -   **Petra**: Aesthetic focus (Atmosphere, Finish, Light, Garden).
    -   **Scoring**: Calculates a % match based on hits/misses.
-   **Narrative**: "Marcel's Tech-Check" and "Petra's Woonwensen" bullet points.

#### **Chapter 3: Technical State (Bouwkundige Staat)**
-   **Goal**: Risk assessment.
-   **Logic**:
    -   **Risk Flags**: Asbestos (pre-1994), Foundation (pre-1950), Lead pipes (pre-1960).
    -   **Advice**: Recommends technical inspections based on age.
-   **Narrative**: Hard-coded warnings if specific year thresholds are triggered.

#### **Chapter 4: Energy & Sustainability (Energie & Duurzaamheid)**
-   **Goal**: Sustainability profile.
-   **Logic**:
    -   **Green**: Labels A-B triggers "Future Proof" text.
    -   **Grey/Red**: Label F-G triggers "Renovation Budget" warnings (€20k-40k estimate).
-   **Visuals**: Timeline or Status badge for Energy Label.

#### **Chapter 5: Layout & Space (Indeling & Ruimte)**
-   **Goal**: Usability of square meters.
-   **Logic**:
    -   **Room Count**: Estimates rooms based on `Area / 25m²` if data missing.
    -   **Space Usage**: Analysis of "En Suite" vs "Open Plan" based on year.

#### **Chapter 6: Maintenance & Finish (Onderhoud & Afwerking)**
-   **Goal**: Renovation requirements.
-   **Logic**:
    -   **Kitchen/Bath cycle**: Calculates age of facilities (assumed from build year if not specified).
    -   **Turn-key vs. DIY**: Classifies as "Klushuis" or "Instapklaar".

#### **Chapter 7: Garden & Outdoors (Tuin & Buiten)**
-   **Goal**: External space analysis.
-   **Logic**:
    -   **Garden Size**: `Plot - Footprint` estimation.
    -   **Experience**: Categorizes as "Park-like", "City Garden", or "Balcony".
    -   **Orientation**: Mentions Sun impact (South/West).

#### **Chapter 8: Mobility (Mobiliteit)**
-   **Goal**: Location context.
-   **Logic**:
    -   **Parking**: History-based prediction (Old city = permit required).
    -   **Transit**: General proximity analysis.

#### **Chapter 9: Legal Aspects (Juridische Aspecten)**
-   **Goal**: Governance and restrictions.
-   **Logic**: Checks for "Appartementsrecht" (VvE context) vs "Volle eigendom".

#### **Chapter 10: Financial Analysis (Financiële Analyse)**
-   **Goal**: Is the price fair?
-   **Logic**:
    -   Calculates Price/m².
    -   Estimates `k.k.` (Purchasing costs ~4%).
    -   Adds "Renovation Buffer" if Energy Label is poor.

#### **Chapter 11: Market Position (Marktpositie)**
-   **Goal**: Buying strategy / Urgency.
-   **Logic**:
    -   High demand price brackets vs Luxury slowdown.
    -   Advice on bidding speed.

#### **Chapter 12: Conclusion (Advies & Conclusie)**
-   **Goal**: Final Verdict.
-   **Logic**:
    -   **Score**: Numeric rating (1-10) derived from Label + Size + Match.
    -   **Advice**: "KOOPWAARDIG" (Buy) or "AANDACHT VEREIST" (Caution).

---

## 4. Implemented Functional Requirements

| ID | Feature | Status | Details |
|----|---------|--------|---------|
| **F-01** | **Robust Parsing** | **Done** | Regex-based integer extraction for Price/Area to handle "m²" and currency formatting errors. |
| **F-02** | **Dynamic Narrative** | **Done** | `IntelligenceEngine` creates non-repetitive text based on data ranges (e.g., "Compact" vs "Royal"). |
| **F-03** | **PDF Export** | **Done** | WeasyPrint integration via `/runs/{id}/pdf`. Includes CSS styling mirroring the web report. |
| **F-04** | **Persistence** | **Done** | SQLite database `runs` table stores core data, JSON steps, and generated chapters. |
| **F-05** | **Offline Mode** | **Done** | Manual HTML paste support prevents scraping blocks from stopping the workflow. |
| **F-06** | **Context Rail** | **Done** | Right-side column dynamically renders "Widgets" (Scores, Badges, Lists) driven by JSON payload. |
| **F-07** | **Unified Source of Truth** | **Done** | Strict enforcement of parsed data as the baseline for all AI narratives. |
| **F-08** | **Global Comparison** | **Done** | Mandatory Marcel & Petra comparison section on every report page. |
| **F-09** | **AI Trust Header** | **Done** | Global header showing Provider, Model, and Confidence level per chapter. |
| **F-10** | **Domain Var Grid** | **Done** | Structured grid showing Fact vs. Inference for 14 variables per chapter. |

---

## 5. Non-Functional Requirements
-   **Performance**: Dashboard must load state < 200ms after fetch.
-   **Privacy**: All data is stored locally (`local_app.db`).
-   **Responsive**: 4K optimization implemented for high-density displays (CSS Grid split).
